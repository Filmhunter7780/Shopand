<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopand - Ваш мини-магазин</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... существующие стили ... */
        .short-link-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .short-link {
            color: #4361ee;
            font-weight: 500;
            word-break: break-all;
        }
        .short-link-btn {
            margin-top: 10px;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            background-color: #25D366;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand logo" href="#" id="homeLink">Shopand</a>
            <div class="d-flex">
                <button id="loginBtn" class="btn btn-outline-primary me-2 d-none">Войти</button>
                <button id="logoutBtn" class="btn btn-outline-danger me-2 d-none">Выйти</button>
                <button id="dashboardBtn" class="btn btn-primary d-none">Мой магазин</button>
            </div>
        </div>
    </nav>

    <!-- Главная страница -->
    <section id="homeSection" class="section active">
        <!-- ... существующее содержимое ... -->
    </section>

    <!-- Регистрация -->
    <section id="registerSection" class="section">
        <!-- ... существующее содержимое ... -->
    </section>

    <!-- Вход -->
    <section id="loginSection" class="section">
        <!-- ... существующее содержимое ... -->
    </section>

    <!-- Личный кабинет -->
    <section id="dashboardSection" class="section">
        <div class="container">
            <h2 class="mb-4">Мой магазин</h2>
            
            <div class="card mb-4">
                <div class="card-body">
                    <div id="shopInfo" class="d-none">
                        <h4><span id="shopNameDisplay"></span></h4>
                        <p id="shopDescriptionDisplay"></p>
                        <p><strong>URL вашего магазина:</strong> 
                            <a href="#" id="shopUrl" target="_blank"></a>
                            <i class="fas fa-copy copy-btn" title="Скопировать ссылку" onclick="copyShopUrl()"></i>
                        </p>
                        
                        <!-- Секция сокращения ссылки -->
                        <div class="short-link-container mt-4">
                            <h5>Сократить ссылку</h5>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="customAlias" placeholder="Ваш вариант (необязательно)">
                                <button class="btn btn-outline-secondary" type="button" id="generateShortLinkBtn">
                                    <i class="fas fa-link"></i> Сократить
                                </button>
                            </div>
                            <div id="shortLinkResult" class="d-none">
                                <p class="mb-1">Ваша короткая ссылка:</p>
                                <p class="short-link" id="shortLink"></p>
                                <button class="btn btn-sm btn-outline-primary short-link-btn" onclick="copyShortUrl()">
                                    <i class="fas fa-copy"></i> Скопировать
                                </button>
                            </div>
                        </div>
                        
                        <button id="editShopBtn" class="btn btn-outline-primary mt-3">Редактировать магазин</button>
                    </div>
                    <div id="noShopInfo" class="d-none">
                        <p class="text-muted">У вас еще нет магазина</p>
                        <button id="createShopFormBtn" class="btn btn-primary">Создать магазин</button>
                    </div>
                </div>
            </div>
            
            <!-- ... остальное содержимое ... -->
        </div>
    </section>

    <!-- Страница магазина -->
    <section id="shopSection" class="section">
        <!-- ... существующее содержимое ... -->
    </section>

    <!-- Подвал -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 Shopand - Платформа для мини-магазинов</p>
        </div>
    </footer>

    <!-- Toast для уведомлений -->
    <div class="toast-container">
        <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i> Ссылка скопирована!
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAPcx4HvmvQXLtlGqHjZIJzvET8AgBjTRA",
            authDomain: "shopand-77667.firebaseapp.com",
            projectId: "shopand-77667",
            storageBucket: "shopand-77667.appspot.com",
            messagingSenderId: "771736514960",
            appId: "1:771736514960:web:28e4f8712d9d1c10670315"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Состояние приложения
        let currentUser = null;
        let currentShop = null;
        let currentProducts = [];
        let editingProductId = null;
        let currentShortLink = null;

        // DOM элементы
        const sections = {
            home: document.getElementById('homeSection'),
            register: document.getElementById('registerSection'),
            login: document.getElementById('loginSection'),
            dashboard: document.getElementById('dashboardSection'),
            shop: document.getElementById('shopSection')
        };
        
        // Кнопки навигации
        document.getElementById('createShopBtn').addEventListener('click', () => showSection('register'));
        document.getElementById('loginHomeBtn').addEventListener('click', () => showSection('login'));
        document.getElementById('toLogin').addEventListener('click', () => showSection('login'));
        document.getElementById('toRegister').addEventListener('click', () => showSection('register'));
        document.getElementById('loginBtn').addEventListener('click', () => showSection('login'));
        document.getElementById('dashboardBtn').addEventListener('click', () => showSection('dashboard'));
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('createShopFormBtn').addEventListener('click', showShopForm);
        document.getElementById('editShopBtn').addEventListener('click', showShopForm);
        document.getElementById('cancelShopBtn').addEventListener('click', hideShopForm);
        document.getElementById('addProductBtn').addEventListener('click', showProductForm);
        document.getElementById('cancelProductBtn').addEventListener('click', hideProductForm);
        document.getElementById('homeLink').addEventListener('click', goToHome);
        document.getElementById('generateShortLinkBtn').addEventListener('click', generateShortLink);

        // Формы
        document.getElementById('registerForm').addEventListener('submit', register);
        document.getElementById('loginForm').addEventListener('submit', login);
        document.getElementById('shopForm').addEventListener('submit', saveShop);
        document.getElementById('productForm').addEventListener('submit', saveProduct);

        // Улучшенная функция нормализации номера WhatsApp
        function normalizePhone(phone) {
            // Удаляем все нецифровые символы
            let cleaned = phone.replace(/\D/g, '');
            
            // Обработка казахстанских номеров:
            // - Если номер начинается с '8' и имеет 11 цифр, заменяем '8' на '7'
            // - Если номер начинается с '7' и имеет 11 цифр, оставляем как есть
            // - Все остальные случаи оставляем без изменений
            if (cleaned.startsWith('8') && cleaned.length === 11) {
                cleaned = '7' + cleaned.substring(1);
            }
            
            // Всегда добавляем '+' в начале
            return '+' + cleaned;
        }

        // Перейти на главную страницу
        function goToHome(e) {
            e.preventDefault();
            const cleanUrl = window.location.href.split('?')[0];
            window.history.replaceState({}, document.title, cleanUrl);
            currentShop = null;
            showSection('home');
        }

        // Показать секцию
        function showSection(sectionName) {
            Object.values(sections).forEach(section => {
                section.classList.remove('active');
            });
            sections[sectionName].classList.add('active');
            
            if (sectionName === 'dashboard' && currentUser) {
                loadUserShop();
                
                // Очистить URL при переходе в кабинет
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
            }
            
            // Очистить магазин при переходе на главную
            if (sectionName === 'home') {
                currentShop = null;
            }
        }

        // Регистрация с улучшенным форматированием телефона
        function register(e) {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const whatsapp = document.getElementById('regWhatsapp').value;
            
            // Нормализуем номер перед сохранением
            const normalizedWhatsapp = normalizePhone(whatsapp);
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    
                    // Сохраняем WhatsApp номер пользователя
                    return db.collection('users').doc(currentUser.uid).set({
                        whatsapp: normalizedWhatsapp
                    });
                })
                .then(() => {
                    showSection('dashboard');
                    updateAuthUI();
                })
                .catch((error) => {
                    alert(`Ошибка регистрации: ${error.message}`);
                });
        }

        // Вход
        function login(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showSection('dashboard');
                    updateAuthUI();
                })
                .catch((error) => {
                    alert(`Ошибка входа: ${error.message}`);
                });
        }

        // Выход
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                currentShop = null;
                
                // Очистить параметры URL
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
                
                showSection('home');
                updateAuthUI();
            });
        }

        // Загрузить магазин пользователя
        function loadUserShop() {
            if (!currentUser) return;
            
            db.collection('shops').where('owner', '==', currentUser.uid).get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach(doc => {
                            currentShop = {
                                id: doc.id,
                                ...doc.data()
                            };
                            displayShopInfo();
                            loadShopProducts();
                            loadExistingShortLink(); // Загружаем существующую короткую ссылку
                        });
                    } else {
                        document.getElementById('shopInfo').classList.add('d-none');
                        document.getElementById('noShopInfo').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error("Ошибка загрузки магазина:", error);
                    alert(`Ошибка загрузки магазина: ${error.message}`);
                });
        }

        // Показать форму магазина
        function showShopForm() {
            document.getElementById('shopFormContainer').classList.remove('d-none');
            document.getElementById('shopInfo').classList.add('d-none');
            document.getElementById('noShopInfo').classList.add('d-none');
            
            if (currentShop) {
                document.getElementById('shopFormTitle').textContent = 'Редактировать магазин';
                document.getElementById('shopName').value = currentShop.name;
                document.getElementById('shopDescription').value = currentShop.description;
            } else {
                document.getElementById('shopFormTitle').textContent = 'Создать магазин';
                document.getElementById('shopName').value = '';
                document.getElementById('shopDescription').value = '';
            }
        }

        // Скрыть форму магазина
        function hideShopForm() {
            document.getElementById('shopFormContainer').classList.add('d-none');
            if (currentShop) {
                document.getElementById('shopInfo').classList.remove('d-none');
            } else {
                document.getElementById('noShopInfo').classList.remove('d-none');
            }
        }

        // Сохранить магазин
        function saveShop(e) {
            e.preventDefault();
            
            const name = document.getElementById('shopName').value;
            const description = document.getElementById('shopDescription').value;
            
            if (!currentUser) {
                alert('Ошибка авторизации. Пожалуйста, войдите снова.');
                return;
            }
            
            // Сначала получим данные пользователя, чтобы взять whatsapp
            db.collection('users').doc(currentUser.uid).get()
                .then(userDoc => {
                    if (!userDoc.exists) {
                        throw new Error('Данные пользователя не найдены');
                    }
                    
                    const userData = userDoc.data();
                    const whatsapp = userData.whatsapp;
                    
                    const shopData = {
                        name: name,
                        description: description,
                        owner: currentUser.uid,
                        ownerWhatsapp: whatsapp, // сохраняем номер в магазине
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (currentShop) {
                        // Если редактирование, то обновляем
                        return db.collection('shops').doc(currentShop.id).update(shopData)
                            .then(() => {
                                currentShop = { ...currentShop, ...shopData };
                            });
                    } else {
                        // Создаем новый магазин
                        return db.collection('shops').add(shopData)
                            .then((docRef) => {
                                currentShop = {
                                    id: docRef.id,
                                    ...shopData
                                };
                            });
                    }
                })
                .then(() => {
                    hideShopForm();
                    displayShopInfo();
                    alert('Магазин успешно сохранен!');
                })
                .catch(error => {
                    console.error("Ошибка сохранения магазина:", error);
                    alert(`Ошибка сохранения магазина: ${error.message}`);
                });
        }

        // Отобразить информацию о магазине
        function displayShopInfo() {
            if (!currentShop) return;
            
            document.getElementById('shopNameDisplay').textContent = currentShop.name;
            document.getElementById('shopDescriptionDisplay').textContent = currentShop.description;
            
            const shopUrl = window.location.href.split('?')[0] + `?shop=${currentShop.id}`;
            document.getElementById('shopUrl').textContent = shopUrl;
            document.getElementById('shopUrl').href = shopUrl;
            
            document.getElementById('shopInfo').classList.remove('d-none');
            document.getElementById('noShopInfo').classList.add('d-none');
        }

        // Копировать ссылку магазина
        function copyShopUrl() {
            const url = document.getElementById('shopUrl').href;
            navigator.clipboard.writeText(url)
                .then(() => showToast('Ссылка магазина скопирована!'))
                .catch(err => console.error('Ошибка копирования: ', err));
        }

        // Показать toast-уведомление
        function showToast(message) {
            const toastEl = document.getElementById('copyToast');
            const toastBody = toastEl.querySelector('.toast-body');
            toastBody.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${message}`;
            
            // Показываем toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            
            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                toast.hide();
            }, 3000);
        }

        // Генерация короткой ссылки
        function generateShortLink() {
            if (!currentShop) {
                alert('Сначала создайте магазин');
                return;
            }
            
            const customAlias = document.getElementById('customAlias').value.trim();
            const originalUrl = document.getElementById('shopUrl').href;
            
            // Если пользователь ввел кастомный алиас, используем его
            let shortCode;
            if (customAlias) {
                if (!/^[a-zA-Z0-9_-]{3,20}$/.test(customAlias)) {
                    alert('Алиас может содержать только буквы, цифры, дефисы и подчеркивания (3-20 символов)');
                    return;
                }
                shortCode = customAlias;
            } else {
                // Генерируем случайный код из 6 символов
                shortCode = Math.random().toString(36).substring(2, 8);
            }
            
            // Сохраняем в Firestore
            db.collection('shortlinks').doc(shortCode).set({
                originalUrl: originalUrl,
                shopId: currentShop.id,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                ownerId: currentUser.uid
            })
            .then(() => {
                currentShortLink = `${window.location.origin}/s/${shortCode}`;
                document.getElementById('shortLink').textContent = currentShortLink;
                document.getElementById('shortLinkResult').classList.remove('d-none');
                showToast('Короткая ссылка создана!');
            })
            .catch(error => {
                if (error.code === 'permission-denied') {
                    alert('Этот алиас уже занят, попробуйте другой');
                } else {
                    console.error("Ошибка создания короткой ссылки:", error);
                    alert(`Ошибка: ${error.message}`);
                }
            });
        }

        // Загрузить существующую короткую ссылку
        function loadExistingShortLink() {
            if (!currentShop || !currentUser) return;
            
            db.collection('shortlinks')
                .where('shopId', '==', currentShop.id)
                .limit(1)
                .get()
                .then(querySnapshot => {
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        currentShortLink = `${window.location.origin}/s/${doc.id}`;
                        document.getElementById('shortLink').textContent = currentShortLink;
                        document.getElementById('shortLinkResult').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error("Ошибка загрузки короткой ссылки:", error);
                });
        }

        // Копировать короткую ссылку
        function copyShortUrl() {
            if (!currentShortLink) return;
            
            navigator.clipboard.writeText(currentShortLink)
                .then(() => showToast('Короткая ссылка скопирована!'))
                .catch(err => console.error('Ошибка копирования: ', err));
        }

        // ... остальные функции (saveProduct, loadShopProducts и т.д.) остаются без изменений ...

        // Инициализация приложения
        function init() {
            // Проверка параметра shop в URL
            const urlParams = new URLSearchParams(window.location.search);
            const shopId = urlParams.get('shop');
            
            // Проверка короткой ссылки
            const path = window.location.pathname;
            if (path.startsWith('/s/')) {
                const shortCode = path.split('/')[2];
                resolveShortLink(shortCode);
                return;
            }
            
            // Проверка авторизации пользователя
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI();
                
                if (shopId && !currentUser) {
                    showShop(shopId);
                } else if (currentUser) {
                    showSection('dashboard');
                } else {
                    showSection('home');
                }
            });
        }

        // Обработка короткой ссылки
        function resolveShortLink(shortCode) {
            db.collection('shortlinks').doc(shortCode).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        window.location.href = data.originalUrl;
                    } else {
                        alert('Короткая ссылка не найдена');
                        showSection('home');
                    }
                })
                .catch(error => {
                    console.error("Ошибка разрешения короткой ссылки:", error);
                    alert('Ошибка загрузки ссылки');
                    showSection('home');
                });
        }

        // Запуск приложения
        init();
        
        // Экспорт функций в глобальную область видимости
        window.buyProduct = buyProduct;
        window.editProduct = editProduct;
        window.copyShopUrl = copyShopUrl;
        window.copyShortUrl = copyShortUrl;
    </script>
    
    <!-- Bootstrap JS (для работы Toast) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
